# Story 2.3.5.2: 반복 일정 단일 수정 시 폼 로딩 로직 개선

## Status

Ready for Development

## Story

**As a** 캘린더 사용자,  
**I want** 반복 일정을 단일 수정할 때 원본 반복 정보가 폼에 표시되기를,  
**so that** 기존 반복 설정을 확인하고 필요시 수정할 수 있다.

## Problem Statement

현재 "이 일정만 수정"을 선택하면:

1. **폼 로딩 전에 `convertToSingleEvent` 실행됨** - 반복 정보가 즉시 제거됨
2. **반복 체크박스가 해제됨** - `isRepeating`이 false로 설정됨
3. **반복 설정 필드들이 숨겨짐** - 사용자가 원본 설정을 볼 수 없음

## Acceptance Criteria

1. **원본 데이터 로딩** - 단일 수정 시 `convertToSingleEvent` 호출하지 않음
2. **반복 정보 표시** - 폼에서 원본 반복 설정이 정확하게 표시됨
3. **체크박스 활성화** - 반복 일정 체크박스가 체크된 상태로 표시됨
4. **필드 표시** - 반복 유형, 간격, 종료일 필드가 모두 보임
5. **단일 수정 플래그 설정** - `startSingleEdit` 함수 호출로 모드 구분

## Technical Solution

### 1. App.tsx의 handleEditRecurringEvent 수정

```typescript
// src/App.tsx - 현재 구현
const handleEditRecurringEvent = (event: Event) => {
  if (event.repeat.type !== 'none') {
    overlay.open(({ isOpen, close }) => (
      <RecurringEditDialog
        isOpen={isOpen}
        targetEvent={event}
        onCancel={close}
        onEditSingle={() => {
          close();
          // 🔥 문제: convertToSingleEvent로 반복 정보 제거
          editEvent(convertToSingleEvent(event));
        }}
      />
    ));
  } else {
    editEvent(event);
  }
};
```

```typescript
// src/App.tsx - 수정된 구현
const handleEditRecurringEvent = (event: Event) => {
  if (event.repeat.type !== 'none') {
    overlay.open(({ isOpen, close }) => (
      <RecurringEditDialog
        isOpen={isOpen}
        targetEvent={event}
        onCancel={close}
        onEditSingle={() => {
          close();
          // ✅ 개선: 원본 데이터로 단일 수정 모드 시작
          startSingleEdit(event);
        }}
      />
    ));
  } else {
    editEvent(event);
  }
};
```

### 2. 편집 상태 훅 통합

```typescript
// src/App.tsx - useEditingState 훅 사용
const { editingEvent, isEditing, isSingleEdit, startEdit, startSingleEdit, stopEditing } =
  useEditingState();

// editEvent 함수를 startEdit로 대체
const editEvent = (event: Event) => startEdit(event);
```

### 3. 폼 상태 초기화 로직 확인

```typescript
// src/hooks/useFormState.ts - 현재 로직 유지
const getInitialFormState = (initialEvent?: Event): FormState => ({
  // ...
  isRepeating: initialEvent ? initialEvent.repeat.type !== 'none' : false,
  // 원본 이벤트가 반복 일정이면 isRepeating이 true가 됨
});
```

## Implementation Tasks

- [ ] **handleEditRecurringEvent 함수 수정**

  - [ ] `convertToSingleEvent` 호출 제거
  - [ ] `startSingleEdit` 함수 호출로 변경
  - [ ] 기존 `editEvent` 호출과 동일한 결과 보장

- [ ] **편집 상태 훅 통합**

  - [ ] `useEditingState` 훅 import 및 사용
  - [ ] 기존 편집 관련 로컬 상태 제거
  - [ ] `editEvent` 함수를 `startEdit`로 통합

- [ ] **동작 검증**
  - [ ] 반복 일정 단일 수정 시 폼에 원본 데이터 표시 확인
  - [ ] 일반 편집 모드 정상 동작 확인
  - [ ] 편집 취소 시 상태 정리 확인

## Test Cases

### Test 1: 반복 일정 단일 수정 시 원본 데이터 로딩

```typescript
test('반복 일정 단일 수정 시 원본 반복 정보가 폼에 표시됨', async () => {
  const recurringEvent = {
    id: '1',
    title: '팀 회의',
    repeat: { type: 'weekly', interval: 1, endDate: '2024-12-31' },
  };

  render(<App />);

  // 반복 일정 클릭
  const eventElement = screen.getByText('팀 회의');
  fireEvent.click(eventElement);

  // "이 일정만 수정" 선택
  const editSingleButton = screen.getByText('이 일정만 수정');
  fireEvent.click(editSingleButton);

  // 폼에서 반복 정보 확인
  expect(screen.getByLabelText('반복 일정')).toBeChecked();
  expect(screen.getByDisplayValue('매주')).toBeInTheDocument();
  expect(screen.getByDisplayValue('1')).toBeInTheDocument();
});
```

### Test 2: 일반 편집 모드 정상 동작

```typescript
test('일반 일정 편집은 기존과 동일하게 동작함', async () => {
  const singleEvent = {
    id: '1',
    title: '개인 약속',
    repeat: { type: 'none' },
  };

  render(<App />);

  const eventElement = screen.getByText('개인 약속');
  fireEvent.click(eventElement);

  // 바로 편집 폼이 열림 (다이얼로그 없음)
  expect(screen.getByLabelText('제목')).toBeInTheDocument();
  expect(screen.queryByText('이 일정만 수정')).not.toBeInTheDocument();
});
```

### Test 3: 단일 수정 플래그 설정

```typescript
test('단일 수정 모드에서 isSingleEdit 플래그가 true로 설정됨', async () => {
  const { result } = renderHook(() => useEditingState());

  const recurringEvent = {
    id: '1',
    repeat: { type: 'weekly' },
  };

  act(() => {
    result.current.startSingleEdit(recurringEvent);
  });

  expect(result.current.isSingleEdit).toBe(true);
  expect(result.current.editingEvent).toBe(recurringEvent);
});
```

## Definition of Done

- [ ] `handleEditRecurringEvent`에서 `convertToSingleEvent` 호출 제거됨
- [ ] 단일 수정 시 `startSingleEdit` 함수 호출됨
- [ ] 반복 일정 단일 수정 시 폼에 원본 정보 표시됨
- [ ] 모든 단위 테스트 통과
- [ ] 일반 편집 모드 정상 동작 확인
- [ ] 코드 리뷰 완료

## Dependencies

**전제 조건:**

- Story 2.3.5.1 (단일 수정 모드 상태 관리 개선) 완료
- 기존 `RecurringEditDialog` 컴포넌트 구현 완료

**다음 스토리:**

- Story 2.3.5.3 (제출 로직 개선) - 제출 시점에 단일 전환 처리

## Estimated Effort

**개발 시간:** 2-3시간  
**테스트 시간:** 2시간  
**총 예상 시간:** 4-5시간

## Notes

이 스토리는 사용자가 반복 일정의 원본 설정을 확인할 수 있게 해주는 핵심 기능입니다. 폼 로딩 시점과 제출 시점을 분리하여 더 나은 사용자 경험을 제공합니다.
