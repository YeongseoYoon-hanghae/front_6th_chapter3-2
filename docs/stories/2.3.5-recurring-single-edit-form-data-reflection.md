# Story 2.3.5: 반복 일정 단일 수정 시 폼 데이터 정확 반영

## Status

Draft

## Story

**As a** 캘린더 사용자,  
**I want** 반복 일정을 단일로 수정할 때 수정 폼에 기존 반복 일정 정보가 정확하게 반영되기를,  
**so that** 반복 일정의 설정을 확인하고 필요시 수정할 수 있다.

## Problem Statement

현재 반복 일정을 "이 일정만 수정"으로 선택할 때, 수정 폼에서 다음과 같은 문제가 발생한다:

1. **반복 일정 체크박스가 체크되지 않음** - 원본이 반복 일정임에도 불구하고 `isRepeating`이 false로 설정됨
2. **반복 설정 필드들이 숨겨짐** - 반복 유형, 간격, 종료일 필드가 보이지 않음
3. **기존 반복 정보 손실** - 사용자가 원본 반복 설정을 확인할 수 없음

## Root Cause Analysis

### 현재 구현의 문제점

1. **`convertToSingleEvent` 함수의 즉시 변환**

   ```typescript
   // src/utils/recurringUtils.ts - 현재 구현
   export function convertToSingleEvent<T extends Event | EventForm>(event: T): T {
     const { repeat, ...rest } = event as Event;
     const nextRepeat = { ...repeat, type: 'none' as RepeatType, interval: 0 };
     delete (nextRepeat as Event['repeat']).id;
     return { ...(rest as T), repeat: nextRepeat } as T;
   }
   ```

2. **`useFormState`의 `isRepeating` 계산 로직**
   ```typescript
   // src/hooks/useFormState.ts - 현재 구현
   const getInitialFormState = (initialEvent?: Event): FormState => ({
     // ...
     isRepeating: initialEvent ? initialEvent.repeat.type !== 'none' : false,
     // convertToSingleEvent로 이미 type이 'none'이 되어 isRepeating이 false가 됨
   });
   ```

## Acceptance Criteria

1. **반복 일정 정보 유지** - 단일 수정 모드 진입 시 원본 반복 일정의 설정이 폼에 표시되어야 함
2. **반복 체크박스 활성화** - `isRepeating` 체크박스가 체크된 상태로 표시되어야 함
3. **반복 설정 필드 표시** - 반복 유형, 간격, 종료일 필드가 보여져야 함
4. **수정 시 단일 전환** - 실제 저장할 때만 단일 일정으로 전환되어야 함
5. **사용자 편의성** - 사용자가 반복 설정을 끄거나 수정할 수 있어야 함

## Technical Solution

### 1. 폼 로딩 시점 개선

현재 `convertToSingleEvent`를 폼 로딩 전에 실행하는 것을 **폼 제출 시점**으로 변경:

```typescript
// App.tsx - 수정된 구현
const handleEditRecurringEvent = (event: Event) => {
  if (event.repeat.type !== 'none') {
    overlay.open(({ isOpen, close }) => (
      <RecurringEditDialog
        isOpen={isOpen}
        targetEvent={event}
        onCancel={close}
        onEditSingle={() => {
          close();
          // convertToSingleEvent 제거 - 원본 데이터로 폼 로딩
          editEvent(event);
        }}
      />
    ));
  } else {
    editEvent(event);
  }
};
```

### 2. 단일 수정 플래그 도입

수정 모드가 단일 수정인지 구분하기 위한 상태 관리:

```typescript
// useEditingState.ts 또는 새로운 상태
interface EditingState {
  editingEvent: Event | null;
  isEditing: boolean;
  isSingleEdit: boolean; // 새로 추가
}

const useEditingState = () => {
  const [editingEvent, setEditingEvent] = useState<Event | null>(null);
  const [isSingleEdit, setIsSingleEdit] = useState(false);

  const startSingleEdit = (event: Event) => {
    setEditingEvent(event);
    setIsSingleEdit(true);
  };

  // ...
};
```

### 3. 제출 시점 단일 전환

폼 제출 시에만 단일 일정으로 전환:

```typescript
// App.tsx - addOrUpdateEvent 함수 수정
const addOrUpdateEvent = async () => {
  // ... 기존 유효성 검사 ...

  let eventData: Event | EventFormType = {
    id: editingEvent ? editingEvent.id : undefined,
    title,
    date,
    startTime,
    endTime,
    description,
    location,
    category,
    repeat: {
      type: isRepeating ? repeatType : 'none',
      interval: repeatInterval,
      endDate: repeatEndDate || undefined,
    },
    notificationTime,
  };

  // 단일 수정 모드인 경우 반복 정보 제거
  if (editingEvent && isSingleEdit) {
    eventData = convertToSingleEvent(eventData);
  }

  // ... 나머지 로직 ...
};
```

### 4. 폼 표시 로직 개선

반복 설정 필드 표시를 위한 조건 수정:

```typescript
// EventForm.tsx - 조건부 렌더링 개선
{
  isRepeating && (
    <Stack spacing={2}>
      {/* 단일 수정 모드일 때 안내 메시지 추가 */}
      {editingEvent && isSingleEdit && (
        <Typography variant="body2" color="info.main">
          이 일정만 수정됩니다. 반복 설정을 해제하면 단일 일정이 됩니다.
        </Typography>
      )}

      <FormControl fullWidth>
        <FormLabel id="repeat-type">반복 유형</FormLabel>
        {/* ... 기존 반복 설정 필드들 ... */}
      </FormControl>
      {/* ... */}
    </Stack>
  );
}
```

## Implementation Tasks

### Phase 1: 상태 관리 개선

- [ ] **단일 수정 플래그 도입**
  - [ ] `useEditingState` 훅에 `isSingleEdit` 상태 추가
  - [ ] `startSingleEdit` 함수 구현
  - [ ] `stopEditing` 함수에 플래그 리셋 로직 추가

### Phase 2: 폼 로딩 로직 수정

- [ ] **`handleEditRecurringEvent` 함수 수정**
  - [ ] `convertToSingleEvent` 호출 제거
  - [ ] 원본 이벤트 데이터로 폼 로딩
  - [ ] 단일 수정 플래그 설정

### Phase 3: 제출 로직 개선

- [ ] **`addOrUpdateEvent` 함수 수정**
  - [ ] 단일 수정 모드 감지 로직 추가
  - [ ] 제출 시점에 `convertToSingleEvent` 호출
  - [ ] 기존 배치 생성 로직과 충돌 방지

### Phase 4: UI/UX 개선

- [ ] **폼 필드 표시 개선**
  - [ ] 단일 수정 모드 안내 메시지 추가
  - [ ] 반복 설정 필드 조건부 표시 로직 확인
  - [ ] 사용자 피드백 개선

### Phase 5: 테스트 및 검증

- [ ] **단위 테스트 작성**

  - [ ] 반복 일정 단일 수정 시나리오 테스트
  - [ ] 폼 데이터 반영 검증 테스트
  - [ ] 제출 시 단일 전환 테스트

- [ ] **통합 테스트 작성**
  - [ ] 전체 플로우 E2E 테스트
  - [ ] 다양한 반복 유형별 테스트
  - [ ] 오류 상황 처리 테스트

## Test Scenarios

### Scenario 1: 매주 반복 일정 단일 수정

```gherkin
Given 매주 목요일 10:00-11:00 "팀 회의" 반복 일정이 있고
When 특정 날짜의 팀 회의를 클릭하고 "이 일정만 수정"을 선택하면
Then 수정 폼에서 다음이 표시되어야 함:
  - 반복 일정 체크박스가 체크됨
  - 반복 유형이 "매주"로 선택됨
  - 반복 간격이 "1"로 표시됨
  - 기존 반복 종료일이 표시됨
And 제목을 "긴급 팀 회의"로 수정하고 저장하면
Then 해당 날짜의 일정만 "긴급 팀 회의"로 변경되고
And 반복 정보가 제거되어 단일 일정이 되어야 함
```

### Scenario 2: 반복 설정 해제

```gherkin
Given 매일 반복되는 "운동" 일정이 있고
When 특정 날짜의 운동 일정을 단일 수정하고
And 반복 일정 체크박스를 해제하면
Then 반복 설정 필드들이 숨겨지고
When 저장하면
Then 해당 날짜만 단일 일정으로 변경되어야 함
```

### Scenario 3: 반복 설정 수정

```gherkin
Given 매월 반복되는 "월례 회의" 일정이 있고
When 특정 날짜의 월례 회의를 단일 수정하고
And 반복 유형을 "매주"로 변경하면
Then 변경된 설정이 폼에 반영되지만
When 저장하면
Then 원본 반복 그룹은 유지되고
And 해당 날짜만 새로운 설정의 단일 일정이 되어야 함
```

## Dependencies

**전제 조건:**

- Story 2.3.1 (반복 일정 수정 감지 및 확인 다이얼로그) 완료
- Story 2.3.2 (반복→단일 전환 로직) 완료
- `useEditingState` 훅 구현 완료
- `convertToSingleEvent` 함수 구현 완료

**연관 Stories:**

- Story 2.3.3 (단일 수정 PUT API 연동) - 제출 로직 연동
- Story 2.3.4 (반복 그룹 무결성 및 캘린더 업데이트) - 저장 후 처리

## Risks & Mitigation

### Risk 1: 기존 단일 일정 수정 영향

**위험도:** Medium  
**완화 방안:** 단일 수정 플래그로 기존 로직과 분리, 충분한 테스트 커버리지 확보

### Risk 2: 복잡한 상태 관리

**위험도:** Medium  
**완화 방안:** 상태 변경을 최소화하고 기존 `useEditingState` 패턴 활용

### Risk 3: 사용자 혼란

**위험도:** Low  
**완화 방안:** 명확한 안내 메시지와 직관적인 UI/UX 제공

## Change Log

| 날짜       | 변경 사항                               | 작성자 |
| ---------- | --------------------------------------- | ------ |
| 2024-12-19 | Story 2.3.5 초기 생성 및 문제 분석 완료 | PO     |

## Notes

이 Story는 사용자 경험 개선을 위한 중요한 개선사항입니다. 반복 일정의 원본 정보를 유지하면서도 수정 시에는 단일 일정으로 전환되는 로직의 정교한 구현이 필요합니다.
